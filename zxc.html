<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>üöÄ ULTIMATE Screener V2</title>
  <style>
    body { background: #121212; color: white; font-family: Arial; margin: 0; padding: 20px; }
    .container { max-width: 1800px; margin: auto; padding: 20px; background: #1e1e1e; border-radius: 10px; }
    h1 { text-align: center; color: #00ffe7; }
    .controls, .stats-bar {
      display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 20px;
    }
    button, select {
      padding: 10px; border-radius: 5px; border: none; background: #222; color: #00ffe7; font-weight: bold;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td {
      padding: 8px; border: 1px solid #333; text-align: center;
    }
    th { background: #222; }
    .long-signal { background: rgba(0, 255, 100, 0.2); }
    .short-signal { background: rgba(255, 0, 0, 0.2); }
  </style>
</head>
<body>
<div class="container">
  <h1>üöÄ ULTIMATE Screener V2</h1>
  <div class="controls">
    <select id="marketType">
      <option value="spot">Spot</option>
      <option value="futures">Futures</option>
    </select>
    <select id="timeframe">
      <option value="15m">15m</option>
      <option value="1h">1h</option>
      <option value="4h">4h</option>
      <option value="1d">1d</option>
    </select>
    <select id="signalType">
      <option value="all">All</option>
      <option value="long">LONG</option>
      <option value="short">SHORT</option>
    </select>
    <button onclick="scan()">üîÑ Refresh</button>
    <button onclick="toggleAutoScan()">Auto Scan: OFF</button>
    <button onclick="exportSignals()">üìÅ Export</button>
  </div>
  <div class="stats-bar">
    <div>Total: <span id="totalSignals">0</span></div>
    <div>TP Hit: <span id="tpHit">0</span></div>
    <div>SL Hit: <span id="slHit">0</span></div>
    <div>Win Rate: <span id="winRate">0%</span></div>
    <div>Last Scan: <span id="lastScan">Never</span></div>
  </div>
  <table>
    <thead>
      <tr>
        <th>Symbol</th><th>RSI</th><th>Current</th><th>Entry</th><th>Signal</th>
        <th>Support</th><th>Resistance</th><th>TP</th><th>SL</th><th>Trend</th><th>Age</th>
      </tr>
    </thead>
    <tbody id="signalTable">
      <tr><td colspan="11">Click Refresh to start</td></tr>
    </tbody>
  </table>
</div>
<script>
const state = {
  market: 'spot',
  timeframe: '15m',
  signalType: 'all',
  signals: [],
  stats: { tp: 0, sl: 0 }
};

function calcRSI(closes, period = 14) {
  let gains = 0, losses = 0;
  for (let i = closes.length - period - 1; i < closes.length - 1; i++) {
    let diff = closes[i + 1] - closes[i];
    diff > 0 ? gains += diff : losses -= diff;
  }
  const avgGain = gains / period;
  const avgLoss = losses / period || 1;
  return 100 - (100 / (1 + avgGain / avgLoss));
}

function calcATR(highs, lows, closes, period = 14) {
  const trs = [];
  for (let i = closes.length - period + 1; i < closes.length; i++) {
    const hl = highs[i] - lows[i];
    const hc = Math.abs(highs[i] - closes[i - 1]);
    const lc = Math.abs(lows[i] - closes[i - 1]);
    trs.push(Math.max(hl, hc, lc));
  }
  return trs.reduce((a, b) => a + b, 0) / trs.length;
}

function scan() {
  document.getElementById('signalTable').innerHTML = '<tr><td colspan="11">Scanning...</td></tr>';
  state.signals = [];
  state.stats = { tp: 0, sl: 0 };

  const market = document.getElementById('marketType').value;
  const timeframe = document.getElementById('timeframe').value;
  const type = document.getElementById('signalType').value;
  const baseUrl = market === 'spot' ? 'api.binance.com' : 'fapi.binance.com';
  const api = market === 'spot' ? '/api/v3' : '/fapi/v1';

  fetch(`https://${baseUrl}${api}/exchangeInfo`)
    .then(res => res.json())
    .then(data => {
      const symbols = data.symbols.filter(s => s.symbol.endsWith('USDT') && s.status === 'TRADING').slice(0, 100);
      return Promise.all(symbols.map(s =>
        fetch(`https://${baseUrl}${api}/klines?symbol=${s.symbol}&interval=${timeframe}&limit=50`)
          .then(r => r.json())
          .then(k => ({ symbol: s.symbol, klines: k }))
      ));
    })
    .then(results => {
      const rows = results.map(({symbol, klines}) => {
        if (klines.length < 30) return '';
        const closes = klines.map(k => parseFloat(k[4]));
        const lows = klines.map(k => parseFloat(k[3]));
        const highs = klines.map(k => parseFloat(k[2]));

        const current = closes.at(-1);
        const entry = closes.at(-2);
        const rsi = calcRSI(closes);
        const atr = calcATR(highs, lows, closes);
        const support = Math.min(...lows.slice(-20));
        const resistance = Math.max(...highs.slice(-20));
        let signal = null;
        let trend = 'Weak';

        if (rsi < 30 && market === 'spot') signal = 'LONG';
        if (rsi < 30 && market === 'futures') signal = 'LONG';
        if (rsi > 70 && market === 'futures') signal = 'SHORT';
        if (!signal || (type !== 'all' && signal !== type.toUpperCase())) return '';

        if (signal === 'LONG') trend = current <= support ? 'Strong' : 'Good';
        if (signal === 'SHORT') trend = current >= resistance ? 'Strong' : 'Good';

        const tp = signal === 'LONG' ? current + 1.5 * atr : current - 1.5 * atr;
        const sl = signal === 'LONG' ? current - atr : current + atr;

        return `<tr class="${signal === 'LONG' ? 'long-signal' : 'short-signal'}">
          <td>${symbol}</td><td>${rsi.toFixed(2)}</td><td>${current.toFixed(4)}</td><td>${entry.toFixed(4)}</td>
          <td>${signal}</td><td>${support.toFixed(4)}</td><td>${resistance.toFixed(4)}</td>
          <td>${tp.toFixed(4)}</td><td>${sl.toFixed(4)}</td><td>${trend}</td><td>0m</td>
        </tr>`;
      }).filter(r => r).join('');

      document.getElementById('signalTable').innerHTML = rows || '<tr><td colspan="11">No valid signals</td></tr>';
      document.getElementById('totalSignals').textContent = results.length;
      document.getElementById('lastScan').textContent = new Date().toLocaleTimeString();
    });
}

let autoScanInt = null;
function toggleAutoScan() {
  const btn = event.target;
  if (autoScanInt) {
    clearInterval(autoScanInt);
    autoScanInt = null;
    btn.textContent = 'Auto Scan: OFF';
  } else {
    scan();
    autoScanInt = setInterval(scan, 300000);
    btn.textContent = 'Auto Scan: ON';
  }
}

function exportSignals() {
  const blob = new Blob([document.getElementById('signalTable').innerHTML], {type: 'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `signals-${Date.now()}.html`;
  a.click();
}
</script>
</body>
</html>